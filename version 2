<?php
function isMobile($phone) {
  $phone = trim($phone);
  return preg_match('/^(09\d{9}|\+989\d{9})$/', $phone);
}
?>

<?php if (isset($phone) && isMobile($phone)): ?>
  <a class="text-sm grow text-center font-semibold text-white px-4 py-2 bg-yellow-600 rounded-lg cursor-pointer"
     onclick="messageModal()">
    ارسال پیامک
  </a>
<?php endif; ?>


<div id="smsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
  <div class="bg-white rounded-2xl shadow-lg w-96 p-6 text-right relative">
    <h2 class="text-xl font-bold mb-4 text-gray-700">ارسال پیامک</h2>

    <label class="block mb-2 text-sm font-medium text-gray-700">شماره موبایل:</label>
    <input id="phone" type="text"
           value="<?php echo htmlspecialchars($phone ?? ''); ?>"
           class="w-full border border-gray-300 rounded-lg p-2 mb-4 focus:ring-2 focus:ring-yellow-400 outline-none"
           placeholder="مثلاً 09123456789">

    <label class="block mb-2 text-sm font-medium text-gray-700">متن پیام:</label>
    <textarea id="messageInput"
              class="w-full border border-gray-300 rounded-lg p-2 mb-3 h-28 resize-none focus:ring-2 focus:ring-yellow-400 outline-none"
              placeholder="متن پیام خود را وارد کنید"></textarea>


    <div id="readyMessages" class="flex flex-wrap gap-2 mb-4"></div>

    <div class="flex justify-between">
      <button onclick="sendSMS()" class="bg-yellow-600 text-white px-4 py-2 rounded-lg hover:bg-yellow-700 transition">
        ارسال
      </button>
      <button type="button" onclick="closeModal()" class="px-4 py-2 border border-gray-400 rounded-lg hover:bg-gray-200 transition">
        بستن
      </button>
    </div>

    <pre id="results" class="mt-4 text-sm text-gray-700"></pre>
  </div>
</div>

<script>
  const modal = document.getElementById('smsModal');
  const messageInput = document.getElementById('messageInput');
  const readyMessagesDiv = document.getElementById('readyMessages');
  const resultsBox = document.getElementById('results');

  function messageModal() {
    modal.classList.remove('hidden');
    loadMessages();
  }

  function closeModal() {
    modal.classList.add('hidden');
  }

  window.onclick = e => { if (e.target === modal) closeModal(); };

async function loadMessages() {
  try {
    const res = await fetch('messages.json');
    if (!res.ok) throw new Error(`خطا در بارگذاری فایل: ${res.status}`);
    const messages = await res.json();

    const readyMessagesDiv = document.getElementById('readyMessages');
    readyMessagesDiv.innerHTML = '';

    messages.forEach(m => {
      const btn = document.createElement('button');
      btn.textContent = m.title;
      btn.className = 'bg-gray-200 hover:bg-gray-300 text-gray-700 px-3 py-1 rounded-lg text-sm';
      btn.onclick = () => {
        document.getElementById('messageInput').value = m.text;
      };
      readyMessagesDiv.appendChild(btn);
    });
  } catch (err) {
    console.error(' خطا در بارگذاری پیام‌ها:', err);
  }
}

  async function sendSMS() {
    const phone = document.getElementById('phone').value.trim();
    const message = messageInput.value.trim();

    if (!phone || !message) {
      alert('شماره و متن پیام الزامی است');
      return;
    }

    resultsBox.textContent = "در حال ارسال...";

    const headers = new Headers();
    headers.append("X-API-KEY", "***"); 
    headers.append("Content-Type", "application/json");

    const body = JSON.stringify({
      lineNumber: "90004752",
      messageText: message,
      mobiles: [phone],
      sendDateTime: null
    });

    try {
      const response = await fetch("https://api.sms.ir/v1/send/bulk", {
        method: 'POST',
        headers,
        body
      });

      const data = await response.json();
      console.log(' پاسخ سرور:', data);
      resultsBox.textContent = JSON.stringify(data, null, 2);

      if (data.status === 1 || data.isSuccessful) {
        alert(' پیام با موفقیت ارسال شد');
        closeModal();
      } else {
        alert(' ارسال پیام ناموفق بود');
      }
    } catch (error) {
      console.error(' خطا:', error);
      resultsBox.textContent = error;
      alert('خطا در اتصال به سرور SMS.ir');
    }
  }
</script>
